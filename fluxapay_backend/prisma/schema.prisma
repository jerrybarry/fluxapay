// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../src/generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Merchant {
  id                  String         @id @default(cuid())
  business_name       String
  email               String         @unique
  phone_number        String         @unique
  country             String
  settlement_currency String
  password            String
  status              MerchantStatus @default(pending_verification)
  created_at          DateTime       @default(now())
  updated_at          DateTime       @updatedAt
  otps                OTP[]
  settlements         Settlement[]
  kyc                 MerchantKYC?
  webhookLogs         WebhookLog[]
  payments            Payment[]
}

model OTP {
  id         String     @id @default(cuid())
  merchant   Merchant   @relation(fields: [merchantId], references: [id])
  merchantId String
  channel    OTPChannel
  code       String
  expires_at DateTime
  created_at DateTime   @default(now())

  @@unique([merchantId, channel])
}

model Settlement {
  id               String           @id @default(cuid())
  merchant         Merchant         @relation(fields: [merchantId], references: [id])
  merchantId       String
  amount           Decimal
  currency         String
  status           SettlementStatus @default(pending)
  fees             Decimal
  breakdown        Json?
  bank_transfer_id String?
  scheduled_date   DateTime
  processed_date   DateTime?
  created_at       DateTime         @default(now())
  updated_at       DateTime         @updatedAt
}

model MerchantKYC {
  id                           String           @id @default(cuid())
  merchant                     Merchant         @relation(fields: [merchantId], references: [id])
  merchantId                   String           @unique
  business_type                BusinessType
  legal_business_name          String
  business_registration_number String?
  country_of_registration      String
  business_address             String
  director_full_name           String
  director_email               String
  director_phone               String
  government_id_type           GovernmentIdType
  government_id_number         String
  kyc_status                   KYCStatus        @default(not_submitted)
  rejection_reason             String?
  reviewed_at                  DateTime?
  reviewed_by                  String?
  documents                    KYCDocument[]
  created_at                   DateTime         @default(now())
  updated_at                   DateTime         @updatedAt
}

model KYCDocument {
  id            String       @id @default(cuid())
  kyc           MerchantKYC  @relation(fields: [kycId], references: [id])
  kycId         String
  document_type DocumentType
  file_name     String
  file_url      String
  public_id     String
  file_size     Int
  mime_type     String
  created_at    DateTime     @default(now())
  updated_at    DateTime     @updatedAt
}

model WebhookLog {
  id              String                @id @default(cuid())
  merchant        Merchant              @relation(fields: [merchantId], references: [id])
  merchantId      String
  event_type      WebhookEventType
  endpoint_url    String
  http_status     Int?
  status          WebhookStatus
  payment_id      String?
  retry_count     Int                   @default(0)
  max_retries     Int                   @default(5)
  next_retry_at   DateTime?
  request_payload Json?
  response_body   String?
  created_at      DateTime              @default(now())
  updated_at      DateTime              @updatedAt
  retryAttempts   WebhookRetryAttempt[]
}

model WebhookRetryAttempt {
  id             String     @id @default(cuid())
  webhookLog     WebhookLog @relation(fields: [webhookLogId], references: [id])
  webhookLogId   String
  attempt_number Int
  http_status    Int?
  response_body  String?
  error_message  String?
  created_at     DateTime   @default(now())
}

model Payment {
  id             String   @id @default(cuid())
  merchant       Merchant @relation(fields: [merchantId], references: [id])
  merchantId     String
  amount         Decimal
  currency       String
  customer_email String
  metadata       Json
  expiration     DateTime
  status         String
  checkout_url   String
  createdAt      DateTime @default(now())
}

model ReconciliationRecord {
  id                    String                @id @default(cuid())
  period_start          DateTime
  period_end            DateTime
  total_usdc_swept      Decimal
  total_fiat_payouts    Decimal
  total_fees            Decimal
  expected_balance      Decimal
  actual_balance        Decimal
  discrepancy           Decimal
  discrepancy_percent   Float
  status                ReconciliationStatus  @default(pending)
  settlements_count     Int
  payments_count        Int
  notes                 String?
  reviewed_by           String?
  reviewed_at           DateTime?
  alerts                ReconciliationAlert[]
  created_at            DateTime              @default(now())
  updated_at            DateTime              @updatedAt
}

model ReconciliationAlert {
  id                    String                    @id @default(cuid())
  reconciliation        ReconciliationRecord      @relation(fields: [reconciliationId], references: [id])
  reconciliationId      String
  alert_type            ReconciliationAlertType
  severity              AlertSeverity
  message               String
  details               Json?
  acknowledged          Boolean                   @default(false)
  acknowledged_by       String?
  acknowledged_at       DateTime?
  created_at            DateTime                  @default(now())
}

// ...existing code...

enum MerchantStatus {
  pending_verification
  active
}

enum OTPChannel {
  email
  phone
}

enum SettlementStatus {
  pending
  processing
  completed
  failed
}

enum BusinessType {
  individual
  registered_business
}

enum GovernmentIdType {
  passport
  national_id
  driver_license
}

enum KYCStatus {
  not_submitted
  pending_review
  approved
  rejected
}

enum DocumentType {
  government_id
  proof_of_business_registration
  proof_of_address
}

enum WebhookEventType {
  payment_completed
  payment_failed
  payment_pending
  refund_completed
  refund_failed
  subscription_created
  subscription_cancelled
  subscription_renewed
}

enum WebhookStatus {
  pending
  delivered
  failed
  retrying
}

enum ReconciliationStatus {
  pending
  matched
  discrepancy
  reviewed
  resolved
}

enum ReconciliationAlertType {
  amount_mismatch
  missing_settlement
  duplicate_payment
  fee_discrepancy
  timing_anomaly
  threshold_exceeded
}

enum AlertSeverity {
  low
  medium
  high
  critical
}
